-- üî• SCRIPT DE REPARACI√ìN PROFUNDA (RESET Y OPTIMIZACI√ìN)
-- Ejecuta esto en el SQL Editor de Supabase

-- 1. Eliminar la tabla actual (limpieza total solicitada)
DROP TABLE IF EXISTS public.businesses CASCADE;

-- 2. Recrear la tabla con el tipo de dato correcto para IDs grandes (BIGINT)
CREATE TABLE public.businesses (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY, -- Soporta IDs de OSM y autoincremento
    name TEXT NOT NULL,
    description TEXT,
    category TEXT,
    address TEXT,
    lat NUMERIC,
    lng NUMERIC,
    owner_id UUID REFERENCES auth.users(id),
    plan_id TEXT DEFAULT 'free',
    is_premium BOOLEAN DEFAULT false,
    is_hidden BOOLEAN DEFAULT false,
    phone TEXT,
    website TEXT,
    group_name TEXT,
    image_url TEXT,
    rating NUMERIC DEFAULT 0,
    review_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Habilitar Seguridad de Fila (RLS)
ALTER TABLE public.businesses ENABLE ROW LEVEL SECURITY;

-- 4. Pol√≠tica: Lectura p√∫blica para todos
CREATE POLICY "Public businesses are viewable by everyone" ON public.businesses
    FOR SELECT USING (NOT is_hidden);

-- 5. Pol√≠tica: Admin tiene control total
CREATE POLICY "Admins have full control" ON public.businesses
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM public.profiles
            WHERE profiles.id = auth.uid()
            AND profiles.role = 'admin'
        )
    );

-- 6. Pol√≠tica: Due√±os pueden actualizar sus propios negocios
CREATE POLICY "Owners can update their own businesses" ON public.businesses
    FOR UPDATE
    USING (auth.uid() = owner_id);

-- ‚úÖ Verificaci√≥n
SELECT 'Tabla businesses recreada exitosamente' as status;
